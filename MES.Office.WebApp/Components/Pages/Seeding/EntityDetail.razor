@page "/seed/entity/{EntityName}"
@rendermode InteractiveServer
@inject ISeeding_Service SeedingService
@inject ISeedDataFilePathResolver PathResolver
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<EntityDetail> Logger
@inject IJSRuntime JSRuntime

<PageTitle>@FormatEntityName(EntityName) - Entity Detail</PageTitle>

<MudPaper Elevation="0" Class="pa-4">
    @* Breadcrumb Navigation *@
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4 pa-0">
        <ItemTemplate Context="item">
            @if (item.Href != null)
            {
                <MudLink Href="@item.Href">@item.Text</MudLink>
            }
            else
            {
                <MudText>@item.Text</MudText>
            }
        </ItemTemplate>
    </MudBreadcrumbs>

    @* Header Section *@
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="8">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@GetCategoryIcon(_category)" Size="Size.Large" Color="@GetCategoryColor(_category)" />
                <div>
                    <MudText Typo="Typo.h4" Class="d-flex align-center gap-2">
                        @FormatEntityName(EntityName)
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Color="@GetCategoryColor(_category)"
                                 Variant="Variant.Filled">
                            @_category
                        </MudChip>
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        View and manage @EntityName seed data and database records
                    </MudText>
                </div>
            </MudStack>
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex justify-end align-center gap-2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="RefreshDataAsync"
                       Disabled="@_isLoading">
                Refresh
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.PlayArrow"
                       OnClick="SeedEntityAsync"
                       Disabled="@(_isLoading || !_seedFileExists)">
                Seed Entity
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.DeleteForever"
                       OnClick="ClearEntityAsync"
                       Disabled="@(_isLoading || _apiRecordCount == 0)">
                Clear Entity
            </MudButton>
        </MudItem>
    </MudGrid>

    @* Loading Indicator *@
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    @* Seeding Progress *@
    @if (_isSeedingInProgress)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Filled.Sync">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <MudText>Seeding @EntityName... Please wait.</MudText>
            </MudStack>
        </MudAlert>
    }

    @* Alert Messages *@
    @if (!string.IsNullOrEmpty(_message))
    {
        <MudAlert Severity="@(_isSuccess ? Severity.Success : Severity.Error)"
                  Class="mb-4"
                  ShowCloseIcon="true"
                  CloseIconClicked="ClearMessage">
            @_message
        </MudAlert>
    }

    @* File Missing Alert - Show prominently when file doesn't exist *@
    @if (!_seedFileExists && !_isLoadingSeedData)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4" Icon="@Icons.Material.Filled.FolderOff">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Seed File Missing</MudText>
            <MudText Typo="Typo.body2" Class="mt-1">
                No seed data file found for @EntityName. Expected location:
            </MudText>
            <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background: rgba(0,0,0,0.05); border-radius: 4px;">
                <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">
                    @(_seedDataFilePath ?? "Unknown path")
                </MudText>
            </MudPaper>
            <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                Create the seed file to enable seeding for this entity.
            </MudText>
        </MudAlert>
    }

    @* JSON Parse Error Alert *@
    @if (!string.IsNullOrEmpty(_seedFileParseError))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Icon="@Icons.Material.Filled.Code">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Seed File Parse Error</MudText>
            <MudText Typo="Typo.body2" Class="mt-1">
                The seed file contains invalid JSON and could not be parsed.
            </MudText>
            <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background: rgba(255,0,0,0.05); border-radius: 4px;">
                <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all; color: #d32f2f;">
                    @_seedFileParseError
                </MudText>
            </MudPaper>
        </MudAlert>
    }

    @* Last Seeding Result - Show detailed errors if any *@
    @if (_lastSeedingResult != null && !_lastSeedingResult.IsSuccess)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Icon="@Icons.Material.Filled.ErrorOutline" ShowCloseIcon="true" CloseIconClicked="ClearLastSeedingResult">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Last Seeding Failed</MudText>
            @if (_lastSeedingResult.EntityResults.TryGetValue(EntityName, out var entityResult))
            {
                <MudText Typo="Typo.body2" Class="mt-1">
                    Status: @entityResult.GetStatusSummary()
                </MudText>
                @if (entityResult.Errors.Any())
                {
                    <MudText Typo="Typo.body2" Class="mt-2 fw-bold">Errors:</MudText>
                    <MudList T="string" Dense="true" Class="mt-1">
                        @foreach (var error in entityResult.Errors.Take(5))
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                <MudText Typo="Typo.body2">@error</MudText>
                            </MudListItem>
                        }
                        @if (entityResult.Errors.Count > 5)
                        {
                            <MudListItem T="string">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    ... and @(entityResult.Errors.Count - 5) more errors
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
                @if (entityResult.ApiError != null)
                {
                    <MudText Typo="Typo.body2" Class="mt-2 fw-bold">API Error Details:</MudText>
                    <MudPaper Elevation="0" Class="pa-2 mt-1" Style="background: rgba(255,0,0,0.05); border-radius: 4px;">
                        <MudText Typo="Typo.body2">
                            <strong>Endpoint:</strong> @entityResult.ApiError.Method @entityResult.ApiError.Endpoint
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Status:</strong> @entityResult.ApiError.StatusCode @entityResult.ApiError.ReasonPhrase
                        </MudText>
                        @if (!string.IsNullOrEmpty(entityResult.ApiError.Message))
                        {
                            <MudText Typo="Typo.body2">
                                <strong>Message:</strong> @entityResult.ApiError.Message
                            </MudText>
                        }
                        @if (!string.IsNullOrEmpty(entityResult.ApiError.Details))
                        {
                            <MudText Typo="Typo.body2" Class="mt-1">
                                <strong>Details:</strong>
                            </MudText>
                            <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap; font-size: 0.8rem;">
                                @entityResult.ApiError.Details
                            </MudText>
                        }
                    </MudPaper>
                }
                @if (entityResult.RecordResults.Any(r => !r.Success && !r.Skipped))
                {
                    <MudText Typo="Typo.body2" Class="mt-2 fw-bold">Failed Records:</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Class="mt-1" Style="max-height: 200px; overflow-y: auto;">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Identifier</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in entityResult.RecordResults.Where(r => !r.Success && !r.Skipped).Take(10))
                            {
                                <tr>
                                    <td>@record.Index</td>
                                    <td>@(string.IsNullOrEmpty(record.Identifier) ? "(unknown)" : record.Identifier)</td>
                                    <td>
                                        @record.ErrorMessage
                                        @if (record.ValidationErrors.Any())
                                        {
                                            <ul style="margin: 0; padding-left: 20px;">
                                                @foreach (var valError in record.ValidationErrors)
                                                {
                                                    <li style="color: #d32f2f;">
                                                        <strong>@valError.PropertyName:</strong> @valError.ErrorMessage
                                                    </li>
                                                }
                                            </ul>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                    @if (entityResult.RecordResults.Count(r => !r.Success && !r.Skipped) > 10)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                            ... and @(entityResult.RecordResults.Count(r => !r.Success && !r.Skipped) - 10) more failed records
                        </MudText>
                    }
                }
            }
            else
            {
                <MudText Typo="Typo.body2" Class="mt-1">@_lastSeedingResult.Errors.FirstOrDefault()</MudText>
            }
        </MudAlert>
    }

    @* Summary Cards *@
    <MudGrid Class="mb-4" Spacing="3">
        @* Seed Data Card *@
        <MudItem xs="12" md="4">
            <MudCard Elevation="2" Class="h-100">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">SEED DATA (JSON)</MudText>
                            <MudText Typo="Typo.h4" Color="@(_seedFileExists ? Color.Primary : Color.Error)">
                                @if (_isLoadingSeedData)
                                {
                                    <MudSkeleton Width="60px" />
                                }
                                else if (!_seedFileExists)
                                {
                                    <span style="font-size: 0.8em;">Missing</span>
                                }
                                else
                                {
                                    @_seedRecordCount
                                }
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(_seedFileExists ? "records in seed file" : "file not found")
                            </MudText>
                        </div>
                        <MudIcon Icon="@(_seedFileExists ? Icons.Material.Filled.Description : Icons.Material.Filled.FolderOff)"
                                 Color="@(_seedFileExists ? Color.Primary : Color.Error)"
                                 Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    @if (_seedFileExists)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                            File Found
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Class="mr-1" />
                            File Missing
                        </MudChip>
                    }
                </MudCardActions>
            </MudCard>
        </MudItem>

        @* Database Records Card *@
        <MudItem xs="12" md="4">
            <MudCard Elevation="2" Class="h-100">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">DATABASE (API)</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Success">
                                @if (_isLoadingApiData)
                                {
                                    <MudSkeleton Width="60px" />
                                }
                                else if (!string.IsNullOrEmpty(_apiError))
                                {
                                    <MudText Color="Color.Warning">N/A</MudText>
                                }
                                else
                                {
                                    @_apiRecordCount
                                }
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">records in database</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Storage"
                                 Color="@(string.IsNullOrEmpty(_apiError) ? Color.Success : Color.Warning)"
                                 Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    @if (_apiDataLoaded && string.IsNullOrEmpty(_apiError))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                            Connected
                        </MudChip>
                    }
                    else if (!string.IsNullOrEmpty(_apiError))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                            @(GetShortApiError())
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                            Loading...
                        </MudChip>
                    }
                </MudCardActions>
            </MudCard>
        </MudItem>

        @* Last Seeded Card *@
        <MudItem xs="12" md="4">
            <MudCard Elevation="2" Class="h-100">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">LAST SEEDED</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Info">
                                @if (_lastSeededAt.HasValue)
                                {
                                    @_lastSeededAt.Value.ToString("MMM dd, yyyy HH:mm")
                                }
                                else
                                {
                                    <span>Never</span>
                                }
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @if (_lastSeededAt.HasValue)
                                {
                                    @GetTimeAgo(_lastSeededAt.Value)
                                }
                                else
                                {
                                    @:No seeding history
                                }
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Schedule"
                                 Color="@(_lastSeededAt.HasValue ? Color.Info : Color.Default)"
                                 Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    @if (_apiRecordCount > 0)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.DataObject" Size="Size.Small" Class="mr-1" />
                            Has Data
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                            <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Small" Class="mr-1" />
                            Empty
                        </MudChip>
                    }
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* Data Grid Section *@
    <MudPaper Elevation="2" Class="mb-4">
        <MudStack Row="true"
                  AlignItems="AlignItems.Center"
                  Justify="Justify.SpaceBetween"
                  Class="pa-3"
                  Style="@GetCategoryHeaderStyle(_category)">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.TableChart" />
                <MudText Typo="Typo.h6">Database Records</MudText>
                @if (_apiDataLoaded && string.IsNullOrEmpty(_apiError))
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                        @_apiRecordCount records
                    </MudChip>
                }
            </MudStack>
            <MudTextField T="string"
                          @bind-Value="_searchString"
                          Placeholder="Search records..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Style="max-width: 300px;" />
        </MudStack>

        @if (_isLoadingApiData)
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                    Loading records from database...
                </MudText>
            </MudStack>
        }
        else if (!string.IsNullOrEmpty(_apiError))
        {
            <MudAlert Severity="Severity.Warning" Class="ma-4">
                <MudText Typo="Typo.body1" Class="fw-bold">Could not load database records</MudText>
                <MudText Typo="Typo.body2">@_apiError</MudText>
            </MudAlert>
        }
        else if (_apiData.Count == 0)
        {
            @* Empty State *@
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudIcon Icon="@Icons.Material.Filled.Inbox"
                         Size="Size.Large"
                         Color="Color.Default"
                         Style="font-size: 64px; opacity: 0.5;" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">
                    No Records Found
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    The database is empty for @FormatEntityName(EntityName). Seed data to populate.
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="SeedEntityAsync"
                           Disabled="@(!_seedFileExists)">
                    Seed @EntityName Now
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudDataGrid T="Dictionary<string, object?>"
                         Items="@FilteredApiData"
                         Dense="true"
                         Hover="true"
                         Striped="true"
                         FixedHeader="true"
                         Height="400px"
                         Class="pa-0">
                <Columns>
                    @foreach (var column in _apiDataColumns.Take(8))
                    {
                        <PropertyColumn Property="x => x.ContainsKey(column) ? x[column] : null"
                                        Title="@FormatColumnName(column)"
                                        Sortable="true"
                                        Filterable="true" />
                    }
                    @if (_apiDataColumns.Count > 8)
                    {
                        <TemplateColumn Title="..." Sortable="false">
                            <CellTemplate>
                                <MudTooltip Text="@GetAdditionalColumnsTooltip()">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                        +@(_apiDataColumns.Count - 8)
                                    </MudChip>
                                </MudTooltip>
                            </CellTemplate>
                        </TemplateColumn>
                    }
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="Dictionary<string, object?>" />
                </PagerContent>
            </MudDataGrid>
        }
    </MudPaper>

    @* Seed File Information *@
    <MudPaper Elevation="1" Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Seed File Information</MudText>
            @if (!_seedFileExists)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                    File Missing
                </MudChip>
            }
        </MudStack>

        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.caption" Color="Color.Secondary">FILE PATH</MudText>
                <MudPaper Elevation="0" Class="pa-2 mt-1" Style="background: var(--mud-palette-background-grey); border-radius: 4px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">
                            @(_seedDataFilePath ?? "Not found")
                        </MudText>
                        @if (!string.IsNullOrEmpty(_seedDataFilePath))
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                           Size="Size.Small"
                                           OnClick="CopyFilePathToClipboard"
                                           Title="Copy path to clipboard" />
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            @if (_seedFileExists && _seedDataColumns.Count > 0)
            {
                <MudItem xs="12" Class="mt-2">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">COLUMNS</MudText>
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mt-1">
                        @foreach (var col in _seedDataColumns)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">
                                @col
                            </MudChip>
                        }
                    </MudStack>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    @* Seed Data Preview Section - Collapsible *@
    @if (_seedFileExists && _seedData.Count > 0)
    {
        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="@($"Seed Data Preview ({_seedData.Count} records)")" Icon="@Icons.Material.Filled.Preview">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                    Preview of the seed data that will be processed. Click on a row to expand details.
                </MudText>
                <MudDataGrid T="Dictionary<string, object?>"
                             Items="@_seedData"
                             Dense="true"
                             Hover="true"
                             Striped="true"
                             FixedHeader="true"
                             Height="300px"
                             Filterable="false"
                             SortMode="SortMode.None">
                    <Columns>
                        <TemplateColumn Title="#" Sortable="false">
                            <CellTemplate>
                                @((_seedData.IndexOf(context.Item) + 1))
                            </CellTemplate>
                        </TemplateColumn>
                        @foreach (var column in _seedDataColumns.Take(6))
                        {
                            <PropertyColumn Property="x => x.ContainsKey(column) ? x[column] : null"
                                            Title="@FormatColumnName(column)" />
                        }
                        @if (_seedDataColumns.Count > 6)
                        {
                            <TemplateColumn Title="..." Sortable="false">
                                <CellTemplate>
                                    <MudTooltip Text="@GetSeedDataTooltip(context.Item)">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                            +@(_seedDataColumns.Count - 6)
                                        </MudChip>
                                    </MudTooltip>
                                </CellTemplate>
                            </TemplateColumn>
                        }
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="Dictionary<string, object?>" PageSizeOptions="new[] { 5, 10, 25 }" />
                    </PagerContent>
                </MudDataGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudPaper>

@using SeedingResultDTO = MES.Office.WebAPI.Contracts.DTOs.WebApp.Seeding.SeedingResult
@using MES.Office.WebAPI.Contracts.DTOs.WebApp.Seeding

@code {
    [Parameter]
    public string EntityName { get; set; } = string.Empty;

    // UI State
    private bool _isLoading;
    private bool _isLoadingSeedData;
    private bool _isLoadingApiData;
    private bool _isSeedingInProgress;
    private string _message = "";
    private bool _isSuccess;
    private string _searchString = "";

    // Breadcrumbs
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Entity Information
    private string _category = "Unknown";
    private DateTime? _lastSeededAt;

    // Seed Data
    private List<Dictionary<string, object?>> _seedData = new();
    private List<string> _seedDataColumns = new();
    private string? _seedDataFilePath;
    private bool _seedFileExists;
    private int _seedRecordCount => _seedData.Count;
    private string? _seedFileParseError;

    // Last Seeding Result (for detailed error display)
    private SeedingResultDTO? _lastSeedingResult;

    // API Data
    private List<Dictionary<string, object?>> _apiData = new();
    private List<string> _apiDataColumns = new();
    private bool _apiDataLoaded;
    private string? _apiError;
    private int _apiRecordCount => _apiData.Count;

    private IEnumerable<Dictionary<string, object?>> FilteredApiData
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_searchString))
                return _apiData;

            return _apiData.Where(row =>
                row.Values.Any(v => v?.ToString()?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(EntityName))
        {
            _category = GetEntityCategory(EntityName);
            UpdateBreadcrumbs();
            await LoadDataAsync();
        }
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Data Seeding", href: "/seed", icon: Icons.Material.Filled.Storage),
            new(_category, href: $"/seed#{_category}"),
            new(FormatEntityName(EntityName), href: null)
        };
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Load seed data and API data in parallel
            var seedDataTask = LoadSeedDataAsync();
            var apiDataTask = LoadApiDataAsync();
            var statusTask = LoadSeedingStatusAsync();

            await Task.WhenAll(seedDataTask, apiDataTask, statusTask);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshDataAsync()
    {
        ClearMessage();
        await LoadDataAsync();
        Snackbar.Add("Data refreshed", Severity.Info);
    }

    private async Task LoadSeedDataAsync()
    {
        _isLoadingSeedData = true;
        _seedData.Clear();
        _seedDataColumns.Clear();

        try
        {
            var fileName = $"{EntityName}.json";
            var subDir = _category switch
            {
                "Configuration" => "Configuration",
                "System" => "Configuration",
                "Objects" => "MasterData",
                "Transactions" => "Transactions",
                _ => "MasterData"
            };

            var baseDir = PathResolver.GetSeedDataBaseDirectory();
            var possiblePaths = new[]
            {
                Path.Combine(baseDir, subDir, fileName),
                Path.Combine(baseDir, "MasterData", fileName),
                Path.Combine(baseDir, "Configuration", fileName),
                Path.Combine(baseDir, "Transactions", fileName),
                Path.Combine(baseDir, "UserManagement", fileName),
                Path.Combine(baseDir, fileName)
            };

            foreach (var path in possiblePaths)
            {
                if (File.Exists(path))
                {
                    _seedDataFilePath = path;
                    _seedFileExists = true;
                    await LoadJsonDataAsync(path);
                    break;
                }
            }

            if (!_seedFileExists)
            {
                _seedDataFilePath = Path.Combine(baseDir, subDir, fileName);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading seed data for {EntityType}", EntityName);
        }
        finally
        {
            _isLoadingSeedData = false;
        }
    }

    private async Task LoadJsonDataAsync(string filePath)
    {
        _seedFileParseError = null;

        try
        {
            var jsonContent = await File.ReadAllTextAsync(filePath);

            // Check if file is empty
            if (string.IsNullOrWhiteSpace(jsonContent))
            {
                _seedFileParseError = "Seed file is empty";
                return;
            }

            var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };

            System.Text.Json.JsonElement jsonElement;
            try
            {
                jsonElement = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(jsonContent, options);
            }
            catch (System.Text.Json.JsonException jsonEx)
            {
                _seedFileParseError = $"Invalid JSON at line {jsonEx.LineNumber}, position {jsonEx.BytePositionInLine}: {jsonEx.Message}";
                Logger.LogError(jsonEx, "JSON parse error in seed file: {FilePath}", filePath);
                return;
            }

            if (jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                var allColumns = new HashSet<string>();

                foreach (var item in jsonElement.EnumerateArray())
                {
                    var dict = new Dictionary<string, object?>();

                    if (item.ValueKind == System.Text.Json.JsonValueKind.Object)
                    {
                        foreach (var prop in item.EnumerateObject())
                        {
                            allColumns.Add(prop.Name);
                            dict[prop.Name] = GetJsonValue(prop.Value);
                        }
                    }

                    _seedData.Add(dict);
                }

                _seedDataColumns = GetOrderedColumns(allColumns);
            }
            else if (jsonElement.ValueKind == System.Text.Json.JsonValueKind.Object)
            {
                // Handle single object or wrapped array
                if (jsonElement.TryGetProperty("items", out var items) ||
                    jsonElement.TryGetProperty("data", out items) ||
                    jsonElement.TryGetProperty("records", out items))
                {
                    if (items.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        var allColumns = new HashSet<string>();
                        foreach (var item in items.EnumerateArray())
                        {
                            var dict = new Dictionary<string, object?>();
                            if (item.ValueKind == System.Text.Json.JsonValueKind.Object)
                            {
                                foreach (var prop in item.EnumerateObject())
                                {
                                    allColumns.Add(prop.Name);
                                    dict[prop.Name] = GetJsonValue(prop.Value);
                                }
                            }
                            _seedData.Add(dict);
                        }
                        _seedDataColumns = GetOrderedColumns(allColumns);
                    }
                }
                else
                {
                    // Single object - add as single record
                    var dict = new Dictionary<string, object?>();
                    var allColumns = new HashSet<string>();
                    foreach (var prop in jsonElement.EnumerateObject())
                    {
                        allColumns.Add(prop.Name);
                        dict[prop.Name] = GetJsonValue(prop.Value);
                    }
                    _seedData.Add(dict);
                    _seedDataColumns = GetOrderedColumns(allColumns);
                }
            }
            else
            {
                _seedFileParseError = $"Expected JSON array or object, found {jsonElement.ValueKind}";
            }
        }
        catch (Exception ex)
        {
            _seedFileParseError = $"Error reading file: {ex.Message}";
            Logger.LogError(ex, "Error parsing JSON from {FilePath}", filePath);
        }
    }

    private async Task LoadApiDataAsync()
    {
        _isLoadingApiData = true;
        _apiData.Clear();
        _apiDataColumns.Clear();
        _apiError = null;
        _apiDataLoaded = false;

        try
        {
            var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "https://localhost:7272";
            var apiEndpoint = GetApiEndpointForEntity(EntityName);

            if (string.IsNullOrEmpty(apiEndpoint))
            {
                _apiError = "No API endpoint configured for this entity type";
                return;
            }

            var client = HttpClientFactory.CreateClient("MesApi");
            client.BaseAddress = new Uri(apiBaseUrl);

            var response = await client.GetAsync(apiEndpoint);

            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                await ParseApiResponseAsync(jsonContent);
                _apiDataLoaded = true;
            }
            else
            {
                _apiError = $"API returned {(int)response.StatusCode}: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            _apiError = $"Error connecting to API: {ex.Message}";
            Logger.LogError(ex, "Error loading API data for {EntityType}", EntityName);
        }
        finally
        {
            _isLoadingApiData = false;
        }
    }

    private async Task ParseApiResponseAsync(string jsonContent)
    {
        var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var jsonDoc = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(jsonContent, options);

        System.Text.Json.JsonElement dataArray;
        if (jsonDoc.ValueKind == System.Text.Json.JsonValueKind.Array)
        {
            dataArray = jsonDoc;
        }
        else if (jsonDoc.TryGetProperty("items", out var items) ||
                 jsonDoc.TryGetProperty("data", out items) ||
                 jsonDoc.TryGetProperty("value", out items))
        {
            dataArray = items;
        }
        else
        {
            _apiData.Add(ParseJsonObject(jsonDoc));
            if (_apiData.Count > 0 && _apiData[0].Keys.Any())
            {
                _apiDataColumns = GetOrderedColumns(_apiData[0].Keys);
            }
            return;
        }

        if (dataArray.ValueKind == System.Text.Json.JsonValueKind.Array)
        {
            var allColumns = new HashSet<string>();

            foreach (var item in dataArray.EnumerateArray())
            {
                if (item.ValueKind == System.Text.Json.JsonValueKind.Object)
                {
                    var dict = ParseJsonObject(item);
                    foreach (var key in dict.Keys)
                    {
                        allColumns.Add(key);
                    }
                    _apiData.Add(dict);
                }
            }

            _apiDataColumns = GetOrderedColumns(allColumns);
        }

        await Task.CompletedTask;
    }

    private Dictionary<string, object?> ParseJsonObject(System.Text.Json.JsonElement element)
    {
        var dict = new Dictionary<string, object?>();
        if (element.ValueKind == System.Text.Json.JsonValueKind.Object)
        {
            foreach (var prop in element.EnumerateObject())
            {
                dict[prop.Name] = GetJsonValue(prop.Value);
            }
        }
        return dict;
    }

    private object? GetJsonValue(System.Text.Json.JsonElement element)
    {
        return element.ValueKind switch
        {
            System.Text.Json.JsonValueKind.String => element.GetString(),
            System.Text.Json.JsonValueKind.Number => element.TryGetInt64(out var l) ? l : element.GetDouble(),
            System.Text.Json.JsonValueKind.True => true,
            System.Text.Json.JsonValueKind.False => false,
            System.Text.Json.JsonValueKind.Null => null,
            System.Text.Json.JsonValueKind.Array => "[Array]",
            System.Text.Json.JsonValueKind.Object => "{Object}",
            _ => element.ToString()
        };
    }

    private List<string> GetOrderedColumns(IEnumerable<string> columns)
    {
        // Priority columns to show first (matched case-insensitively)
        var priorityOrder = new[] { "id", "code", "name", "description", "number" };
        var columnList = columns.ToList();

        // Find priority columns with their ACTUAL casing from the data
        var orderedPriority = priorityOrder
            .Select(p => columnList.FirstOrDefault(c => string.Equals(c, p, StringComparison.OrdinalIgnoreCase)))
            .Where(c => c != null)
            .ToList();

        // Add remaining columns (not in priority list) in alphabetical order
        var remaining = columnList
            .Where(c => !priorityOrder.Any(p => string.Equals(c, p, StringComparison.OrdinalIgnoreCase)))
            .OrderBy(c => c);

        return orderedPriority.Concat(remaining).ToList();
    }

    private async Task LoadSeedingStatusAsync()
    {
        try
        {
            var result = await SeedingService.GetSeedingStatusAsync();
            if (result.IsSuccess && result.Value != null)
            {
                _lastSeededAt = result.Value.LastSeedingDate;
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Could not load seeding status");
        }
    }

    private async Task SeedEntityAsync()
    {
        _isSeedingInProgress = true;
        _isLoading = true;
        _lastSeedingResult = null;
        StateHasChanged();

        try
        {
            var result = await SeedingService.SeedSpecificEntityAsync(EntityName);
            _isSuccess = result.IsSuccess;

            // Store the result for detailed error display
            if (result.IsSuccess && result.Value != null)
            {
                _lastSeedingResult = result.Value;

                // Build success message with details
                var entityResult = result.Value.EntityResults.TryGetValue(EntityName, out var er) ? er : null;
                if (entityResult != null)
                {
                    var parts = new List<string>();
                    if (entityResult.SuccessCount > 0)
                        parts.Add($"{entityResult.SuccessCount} created");
                    if (entityResult.SkippedCount > 0)
                        parts.Add($"{entityResult.SkippedCount} skipped (already exist)");
                    if (entityResult.FailureCount > 0)
                        parts.Add($"{entityResult.FailureCount} failed");

                    _message = $"Seeded {EntityName}: {string.Join(", ", parts)}";
                }
                else
                {
                    _message = $"Successfully seeded {EntityName}: {result.Value.SuccessCount} records";
                }

                // Clear the result if successful (no need to show error panel)
                if (result.Value.FailureCount == 0)
                {
                    _lastSeedingResult = null;
                }
            }
            else
            {
                // Store failure result for detailed display
                _lastSeedingResult = result.Value;
                _message = $"Failed to seed {EntityName}: {result.Message}";
            }

            Snackbar.Add(_message, _isSuccess ? Severity.Success : Severity.Error);

            // Refresh data to show new records
            await LoadApiDataAsync();
            await LoadSeedingStatusAsync();
        }
        catch (Exception ex)
        {
            _isSuccess = false;
            _message = $"Error seeding {EntityName}: {ex.Message}";
            Snackbar.Add(_message, Severity.Error);
            Logger.LogError(ex, "Error seeding entity: {EntityType}", EntityName);
        }
        finally
        {
            _isSeedingInProgress = false;
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearEntityAsync()
    {
        var parameters = new DialogParameters<ConfirmClearDialog>
        {
            { x => x.ContentText, $"WARNING: This will delete ALL {EntityName} records from the database!" },
            { x => x.ConfirmationCode, $"DELETE_{EntityName.ToUpperInvariant()}" }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmClearDialog>($"Clear {EntityName}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            _isLoading = true;
            StateHasChanged();

            try
            {
                var clearResult = await SeedingService.ClearEntityDataAsync(EntityName);
                _isSuccess = clearResult.IsSuccess;
                _message = clearResult.IsSuccess
                    ? $"Successfully cleared all {EntityName} records"
                    : $"Failed to clear {EntityName}: {clearResult.Message}";

                Snackbar.Add(_message, _isSuccess ? Severity.Success : Severity.Error);

                // Refresh data
                await LoadApiDataAsync();
            }
            catch (Exception ex)
            {
                _isSuccess = false;
                _message = $"Error clearing {EntityName}: {ex.Message}";
                Snackbar.Add(_message, Severity.Error);
                Logger.LogError(ex, "Error clearing entity: {EntityType}", EntityName);
            }
            finally
            {
                _isLoading = false;
                StateHasChanged();
            }
        }
    }

    private void ClearMessage()
    {
        _message = "";
    }

    private void ClearLastSeedingResult()
    {
        _lastSeedingResult = null;
    }

    private string GetSeedDataTooltip(Dictionary<string, object?> record)
    {
        if (record == null || _seedDataColumns.Count <= 6)
            return "";

        var additionalCols = _seedDataColumns.Skip(6).Take(10);
        var parts = additionalCols.Select(col =>
        {
            var value = record.TryGetValue(col, out var v) ? v?.ToString() ?? "null" : "N/A";
            if (value.Length > 30)
                value = value.Substring(0, 27) + "...";
            return $"{col}: {value}";
        });

        return string.Join("\n", parts);
    }

    private async Task CopyFilePathToClipboard()
    {
        if (!string.IsNullOrEmpty(_seedDataFilePath))
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _seedDataFilePath);
                Snackbar.Add("File path copied to clipboard", Severity.Info);
            }
            catch
            {
                Snackbar.Add("Could not copy to clipboard", Severity.Warning);
            }
        }
    }

    #region Helper Methods

    private string FormatEntityName(string entity)
    {
        return System.Text.RegularExpressions.Regex.Replace(entity, "([a-z])([A-Z])", "$1 $2");
    }

    private string FormatColumnName(string column)
    {
        var formatted = System.Text.RegularExpressions.Regex.Replace(column, "([a-z])([A-Z])", "$1 $2");
        return char.ToUpper(formatted[0]) + formatted.Substring(1);
    }

    private string GetEntityCategory(string entityType)
    {
        if (ConfigEntities.Any(e => e.ToString().Equals(entityType, StringComparison.OrdinalIgnoreCase)))
            return "Configuration";
        if (SystemEntities.Any(e => e.ToString().Equals(entityType, StringComparison.OrdinalIgnoreCase)))
            return "System";
        if (ObjectEntities.Any(e => e.ToString().Equals(entityType, StringComparison.OrdinalIgnoreCase)))
            return "Objects";
        if (TransactionEntities.Any(e => e.ToString().Equals(entityType, StringComparison.OrdinalIgnoreCase)))
            return "Transactions";
        return "Unknown";
    }

    private Color GetCategoryColor(string category) => category switch
    {
        "Configuration" => Color.Info,
        "System" => Color.Secondary,
        "Objects" => Color.Primary,
        "Transactions" => Color.Warning,
        _ => Color.Default
    };

    private string GetCategoryIcon(string category) => category switch
    {
        "Configuration" => Icons.Material.Filled.Settings,
        "System" => Icons.Material.Filled.Memory,
        "Objects" => Icons.Material.Filled.Inventory,
        "Transactions" => Icons.Material.Filled.Receipt,
        _ => Icons.Material.Filled.Folder
    };

    private string GetCategoryHeaderStyle(string category)
    {
        var color = category switch
        {
            "Configuration" => "#e3f2fd",
            "System" => "#f5f5f5",
            "Objects" => "#e8f5e9",
            "Transactions" => "#fff3e0",
            _ => "#fafafa"
        };
        return $"background: linear-gradient(135deg, {color} 0%, #fafafa 100%); border-radius: 4px 4px 0 0;";
    }

    private string GetShortApiError()
    {
        if (string.IsNullOrEmpty(_apiError)) return "";
        if (_apiError.Contains("No API endpoint")) return "No Endpoint";
        if (_apiError.Contains("Error connecting")) return "Connection Error";
        return "Error";
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} hours ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays} days ago";
        return date.ToString("MMM dd, yyyy");
    }

    private string GetAdditionalColumnsTooltip()
    {
        if (_apiDataColumns.Count <= 8) return "";
        var additionalCols = _apiDataColumns.Skip(8).Take(10);
        var tooltip = string.Join(", ", additionalCols);
        if (_apiDataColumns.Count > 18)
        {
            tooltip += $", and {_apiDataColumns.Count - 18} more...";
        }
        return tooltip;
    }

    private string? GetApiEndpointForEntity(string entityType)
    {
        return entityType switch
        {
            // Organization
            "Company" => "/api/companies",
            "Department" => "/api/departments",
            "Project" => "/api/projects",

            // Stock/Inventory
            "Site" => "/api/sites",
            "Warehouse" => "/api/warehouses",
            "Location" => "/api/locations",
            "StockBin" => "/api/stock-bins",
            "Product" => "/api/products",
            "ProductCategory" => "/api/product-categories",
            "ProductBatch" => "/api/product-batches",
            "StockMovementReason" => "/api/stock/movement-reasons",

            // Common/Master Data
            "UnitOfMeasure" => "/api/uom",
            "Partner" => "/api/partners",
            "Address" => "/api/addresses",
            "Contact" => "/api/contacts",
            "WorkflowStatus" => "/api/workflows/statuses",

            // Localization
            "Language" => "/api/configuration/localization/languages",

            // Sales
            "Customer" => "/api/customers",

            // Purchasing
            "Supplier" => "/api/suppliers",
            "Carrier" => "/api/carriers",

            // Production
            "Machine" => "/api/machines",
            "WorkOrder" => "/api/workorders",

            // User Management
            "User" => "/api/users",
            "Role" => "/api/roles",
            "SecurityGroup" => "/api/securitygroups",
            "Permission" => "/api/permissions",

            // Configuration
            "BusinessRule" => "/api/configuration/business-rules",
            "EntityTransactionNumber" => "/api/configuration/transaction-numbers",

            // Stock Transactions
            "StockIssueRequest" => "/api/stock/issue-requests",
            "StockAdjustment" => "/api/stock/adjustments",
            "StockBinTransfer" => "/api/stock/bin-transfers",
            "StockBinTransferRequest" => "/api/stock/bin-transfer-requests",
            "InterWarehouseTransfer" => "/api/stock/warehouse-transfers",
            "InterSiteTransfer" => "/api/stock/inter-site-transfers",

            // Purchasing Transactions
            "PurchaseOrder" => "/api/purchasing/purchase-orders",
            "PurchaseDeliveryNote" => "/api/purchasing/delivery-notes",
            "PurchaseReturn" => "/api/purchasing/returns",
            "ShippingNote" => "/api/purchasing/shipping-notes",

            // Audit/Logging
            "AuditLogItem" => "/api/audit-logs",

            // Entities without known endpoints
            _ => null
        };
    }

    #endregion

    #region Entity Type Categories

    private static readonly EntityType[] ConfigEntities =
    {
        EntityType.AuditLogItem,
        EntityType.StockMovement
    };

    private static readonly EntityType[] SystemEntities =
    {
        EntityType.Document,
        EntityType.Note,
        EntityType.EntityTransactionNumber,
        EntityType.PropertyFormattingRule,
        EntityType.PropertyDisplayInformation,
        EntityType.BusinessRule,
        EntityType.ProductBatch
    };

    private static readonly EntityType[] ObjectEntities =
    {
        EntityType.User,
        EntityType.Role,
        EntityType.SecurityGroup,
        EntityType.Permission,
        EntityType.WorkflowStatus,
        EntityType.Supplier,
        EntityType.Address,
        EntityType.Contact,
        EntityType.StockMovementReason,
        EntityType.Product,
        EntityType.ProductCategory,
        EntityType.UnitOfMeasure,
        EntityType.Customer,
        EntityType.Warehouse,
        EntityType.Company,
        EntityType.Site,
        EntityType.Location,
        EntityType.StockBin,
        EntityType.Carrier,
        EntityType.PaymentTerms,
        EntityType.Department,
        EntityType.Machine,
        EntityType.WorkOrder,
        EntityType.Project,
        EntityType.Partner
    };

    private static readonly EntityType[] TransactionEntities =
    {
        EntityType.PurchaseOrder,
        EntityType.ShippingNote,
        EntityType.PurchaseDeliveryNote,
        EntityType.PurchaseReturn,
        EntityType.StockBinTransfer,
        EntityType.StockBinTransferRequest,
        EntityType.StockIssue,
        EntityType.StockIssueRequest,
        EntityType.StockAdjustment,
        EntityType.StockTake,
        EntityType.StockReservation,
        EntityType.StockQuarantine,
        EntityType.InterWarehouseTransfer,
        EntityType.InterSiteTransfer,
        EntityType.SalesOrder,
        EntityType.SalesPickingNote,
        EntityType.SalesDeliveryNote,
        EntityType.SalesShippingNote,
        EntityType.SalesPackingNote,
        EntityType.SalesReturn,
        EntityType.StockPutAway
    };

    #endregion
}
